name: Invicti ASPM Workflow

on:
  push:
    branches: [main, develop]

  pull_request:
    branches: [main]

  workflow_dispatch:
    inputs:
      host:
        description: 'ASPM host'
        type: string
        default: "https://appsecsanta.invicti.com"

      skip_gate:
        description: 'Skip security gate (emergency only)'
        type: boolean
        default: false

      async_mode:
        description: 'Run scans/imports asynchronously'
        type: boolean
        default: false

  workflow_call:
    inputs:
      host:
        type: string
        default: "https://appsecsanta.invicti.com"

      skip_gate:
        type: boolean
        default: false

      async_mode:
        type: boolean
        default: false

    secrets:
      KONDUKTO_TOKEN:
        required: true

jobs:
# ===========================================================================
# Stage 1: SAST Scans
# ===========================================================================
  sast-scan:
    name: ðŸ” SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          pip install semgrep
          semgrep scan \
            --config "p/default" \
            --config "p/security-audit" \
            --config "p/secrets" \
            --json \
            --output semgrep-results.json \
            . || true

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: semgrep-results.json
          retention-days: 7

# ===========================================================================
# Stage 2: Secret Scans
# ===========================================================================
  secrets-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        run: |
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest \
            filesystem /pwd \
            --json \
            --only-verified \
            > trufflehog-results.json 2>/dev/null || true

      - name: Upload secret scan results
        uses: actions/upload-artifact@v4
        with:
          name: secrets-results
          path: trufflehog-results.json
          retention-days: 7

# ===========================================================================
# Stage 3: SCA / Dependency Scanning
# ===========================================================================
  sca-scan:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run OSV Scanner
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
          ./osv-scanner scan source --output osv-results.json  --format=json . 2>/dev/null || true
      
      - name: Upload SCA results
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: |
            osv-results.json
          retention-days: 7

# ===========================================================================
# Stage 4: ASPM Project Onboarding
# ===========================================================================
  kdt-create:
    name: ASPM Onboard Project
    needs: [sast-scan, secrets-scan, sca-scan]
    runs-on: ubuntu-latest
    env:
      KONDUKTO_TOKEN: ${{ secrets.KONDUKTO_TOKEN }}
      KONDUKTO_HOST: ${{ inputs.host }}
      #KONDUKTO_HOST: https://appsecsanta.invicti.com
      PROJECT_NAME: ${{ github.event.repository.name }}
      REPO_URL: ${{ github.server_url }}/${{ github.repository }}

    steps:
      - uses: actions/checkout@v4

      - name: Download SAST results
        uses: actions/download-artifact@v4
        with:
          name: sast-results
          path: artifacts/sast

      - name: Download SCA results
        uses: actions/download-artifact@v4
        with:
          name: sca-results
          path: artifacts/sca

      - name: Download Secret results
        uses: actions/download-artifact@v4
        with:
          name: secrets-results
          path: artifacts/secret

      - name: Install KDT CLI
        run: |
          curl -sSL https://raw.githubusercontent.com/kondukto-io/kdt/master/get.sh | bash
          kdt version

      - name: Determine branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "branch=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "branch=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Project
        run: |
          kdt create project \
            --repo-id "${REPO_URL}" \
            --alm-tool github \
            --product-name AutoGithub \
            --insecure || true

      - name: Import SAST results (Semgrep)
        if: always()
        run: |
          if [ -f "artifacts/sast/semgrep-results.json" ]; then
            kdt scan \
              --repo-id "${REPO_URL}" \
              -b "${{ steps.branch.outputs.branch }}" \
              -t semgrep \
              --file artifacts/sast/semgrep-results.json \
              --insecure || true
          fi

      - name: Import SCA results (OSV)
        if: always()
        run: |
          if [ -f "artifacts/sca/osv-results.json" ]; then
            kdt scan \
              --repo-id "${REPO_URL}" \
              -b "${{ steps.branch.outputs.branch }}" \
              -t osvscannersca \
              --file artifacts/sca/osv-results.json \
              --insecure || true
          fi

      - name: Import Secret results (TruffleHog)
        if: always()
        run: |
          if [ -f "artifacts/secret/trufflehog-results.json" ]; then
            kdt scan \
              --repo-id "${REPO_URL}" \
              -b "${{ steps.branch.outputs.branch }}" \
              -t trufflehog \
              --file artifacts/secret/trufflehog-results.json \
              --insecure || true
          fi