name: Invicti ASPM Workflow

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: 
    inputs:
      skip_gate:
        description: 'Skip security gate (emergency only)'
        type: boolean
        default: false
  workflow_call:
    secrets:
      KONDUKTO_TOKEN:
        required: true

jobs:
# ===========================================================================
# Stage 1: SAST Scans
# ===========================================================================
  sast-scan:
    name: ðŸ” SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        id: semgrep
        run: |
          pip install semgrep
          semgrep scan \
            --config "p/default" \
            --config "p/security-audit" \
            --config "p/secrets" \
            --json \
            --output semgrep-results.json \
            . || true

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: semgrep-results.json
          retention-days: 7
    secrets-scan:
      name: ðŸ” Secret Detection
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Run Gitleaks
          uses: gitleaks/gitleaks-action@v2
          continue-on-error: true
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Run TruffleHog
          id: trufflehog
          run: |
            docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest \
            filesystem /pwd \
            --json \
            --only-verified \
            > trufflehog-results.json 2>/dev/null || true

        - name: Upload secret scan results
          uses: actions/upload-artifact@v4
          with:
            name: secrets-results
            path: |
              trufflehog-results.json
            retention-days: 7

# ===========================================================================
# Stage 3: Project Onboarding 
# ===========================================================================
kdt-create:
  name: ASPM Onboard Project
  needs: [secrets-scan, sast-scan]
  runs-on: ubuntu-latest
  env:
    KONDUKTO_TOKEN: ${{ secrets.KONDUKTO_TOKEN }}
    KONDUKTO_HOST: https://appsecsanta.invicti.com
    PROJECT_NAME: ${{ github.event.repository.name }}
    REPO_URL: ${{ github.server_url }}/${{ github.repository }}

  steps:
    - name: Install KDT CLI
      run: |
        curl -sSL https://raw.githubusercontent.com/kondukto-io/kdt/master/get.sh | bash
        kdt version

    - name: Determine branch
      id: branch
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
        else
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Create Project
      id: kdt-create
      run: |
        kdt create project --repo-id "${{ env.REPO_URL }}" --alm-tool github --product-name AutoGithub --insecure || true

    - name: Import SAST results (semgrep)
      if: always()
      run: |
        if [ -f "scan-results/sast-results/semgrep-results.json" ]; then
            echo "Importing Semgrep results..."
            kdt scan import \
              -p "${{ env.REPO_URL }}" \
              -b "${{ steps.branch.outputs.branch }}" \
              -t semgrep \
              --insecure \
              --file scan-results/sast-results/semgrep-results.json || true
        fi